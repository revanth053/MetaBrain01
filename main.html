<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metabrain chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="main.css">
  <!-- Add Recharts library -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.7.2/umd/Recharts.min.js"></script>
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="chart-utils.js"></script>
  <script type="module">
    import { createChat, getAllChats, getChatsByUserId, deleteChat } from './chatApi.js';
    import { createResponse, getAllResponses, reactToResponse } from './responsesApi.js';
    import { createMessage, getMessagesByChatId } from './messageApi.js';
  </script>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div>
      <div class="logo">
        <a href="#" id="logoHomeBtn">
          <img src="images/logo.png" alt="MetaBrain" class="logo-img full-logo">
          <svg width="38" height="38" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="logo-img closed-logo" style="display: none;">
            <path d="M19.9999 18.3334L3.33325 0H9.99992L23.3333 18.3334H19.9999ZM19.9999 18.3334L36.6666 0H29.9999L6.66659 39.1667H13.3333L22.4999 22.5L29.9999 39.1667H36.6666L19.9999 18.3334Z" fill="#0066B3"/>
          </svg>
        </a>
      </div>
      <nav class="nav-menu">
        <a href="main.html" class="nav-item" id="actionTwinNav">
          <span class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#7A8CA6" xmlns="http://www.w3.org/2000/svg">
              <path d="M0.5 4.63524V15.3651C0.501387 15.7662 0.613983 16.159 0.825267 16.4999C1.21885 17.1408 1.91638 17.532 2.66845 17.5336H15.8848C16.8792 17.5336 17.7462 16.8573 17.9882 15.8928L19.4338 10.9454C19.7263 9.78408 19.0219 8.60555 17.8605 8.31311C17.8191 8.30266 17.7773 8.29344 17.7352 8.28546V7.52651C17.7352 6.32891 16.7644 5.35806 15.5668 5.35806H10.6989C10.3608 5.36876 10.0605 5.14353 9.97611 4.81595L9.80263 4.09313C9.55782 3.14471 8.7076 2.47816 7.72815 2.4668H2.66845C1.47085 2.4668 0.5 3.43764 0.5 4.63524ZM1.94563 4.63524C1.94563 4.23604 2.26925 3.91243 2.66845 3.91243H7.72815C8.06626 3.90173 8.36657 4.12696 8.45097 4.45454L8.62444 5.17736C8.86926 6.12578 9.71948 6.79233 10.6989 6.80369H15.5668C15.966 6.80369 16.2896 7.12731 16.2896 7.52651V8.24932H5.15493C4.23026 8.24268 3.40311 8.82314 3.09491 9.69495L1.94563 13.1789L1.94563 4.63524Z" fill="#5A6E7C"/>
            </svg>
          </span>
          <span>Action Twin</span>
        </a>
        <a href="main.html" class="nav-item" id="talkAnalystNav">
          <span class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#7A8CA6" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.5386 0.513184H5.46103C2.71672 0.513184 0.5 2.70342 0.5 5.42143V11.1741C0.5 13.3381 1.92488 15.1852 3.90401 15.8184C4.59007 16.0296 5.03862 16.663 5.03862 17.3753V18.9587C5.03862 19.381 5.54005 19.6447 5.88315 19.381L9.81507 16.399C10.1054 16.1879 10.4748 16.0559 10.8442 16.0559H14.5385C17.283 16.0826 19.5 13.8923 19.5 11.1745V5.42184C19.5 2.70383 17.2832 0.513593 14.539 0.513593L14.5386 0.513184ZM4.98603 10.013C4.19433 10.013 3.53462 9.35331 3.53462 8.56161C3.53462 7.76991 4.19433 7.1102 4.98603 7.1102C5.77773 7.1102 6.43744 7.76991 6.43744 8.56161C6.43726 9.35331 5.77754 10.013 4.98603 10.013ZM9.99984 10.013C9.20814 10.013 8.54842 9.35331 8.54842 8.56161C8.54842 7.76991 9.20814 7.1102 9.99984 7.1102C10.7915 7.1102 11.4512 7.76991 11.4512 8.56161C11.4512 9.35331 10.7915 10.013 9.99984 10.013ZM15.0136 10.013C14.2219 10.013 13.5622 9.35331 13.5622 8.56161C13.5622 7.76991 14.2219 7.1102 15.0136 7.1102C15.8053 7.1102 16.465 7.76991 16.465 8.56161C16.465 9.35331 15.8053 10.013 15.0136 10.013Z" fill="#5A6E7C"/>
            </svg>
          </span>
          <span>Talk with Analyst</span>
        </a>
        <a href="report.html" class="nav-item" id="savedReportsNav">
          <span class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#7A8CA6" xmlns="http://www.w3.org/2000/svg">
              <path d="M0.5 4.63524V15.3651C0.501387 15.7662 0.613983 16.159 0.825267 16.4999C1.21885 17.1408 1.91638 17.532 2.66845 17.5336H15.8848C16.8792 17.5336 17.7462 16.8573 17.9882 15.8928L19.4338 10.9454C19.7263 9.78408 19.0219 8.60555 17.8605 8.31311C17.8191 8.30266 17.7773 8.29344 17.7352 8.28546V7.52651C17.7352 6.32891 16.7644 5.35806 15.5668 5.35806H10.6989C10.3608 5.36876 10.0605 5.14353 9.97611 4.81595L9.80263 4.09313C9.55782 3.14471 8.7076 2.47816 7.72815 2.4668H2.66845C1.47085 2.4668 0.5 3.43764 0.5 4.63524ZM1.94563 4.63524C1.94563 4.23604 2.26925 3.91243 2.66845 3.91243H7.72815C8.06626 3.90173 8.36657 4.12696 8.45097 4.45454L8.62444 5.17736C8.86926 6.12578 9.71948 6.79233 10.6989 6.80369H15.5668C15.966 6.80369 16.2896 7.12731 16.2896 7.52651V8.24932H5.15493C4.23026 8.24268 3.40311 8.82314 3.09491 9.69495L1.94563 13.1789L1.94563 4.63524Z" fill="#5A6E7C"/>
              
            </svg>
          </span>
          <span>Saved Reports</span>
        </a>
        <a href="main.html" class="nav-item" id="projectNav">
          <span class="icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#7A8CA6" xmlns="http://www.w3.org/2000/svg">
              <path d="M19.5 6.04056C19.5 6.45457 19.26 6.82857 18.89 7.00057L10.452 10.9626C10.31 11.0286 10.152 11.0626 9.998 11.0626C9.84399 11.0626 9.68999 11.0286 9.548 10.9626L1.11401 7.00057C0.73999 6.82857 0.5 6.45457 0.5 6.04056C0.5 5.62857 0.73999 5.25858 1.11401 5.08255L9.548 1.12056C9.83398 0.984552 10.166 0.984552 10.452 1.12056L18.89 5.08255C19.264 5.25858 19.5 5.63255 19.5 6.04056Z" fill="#5A6E7C"/>
              <path d="M1.11332 10.9621L9.54833 14.9232C9.68991 14.9892 9.84407 15.0238 9.99824 15.0238C10.1524 15.0238 10.3097 14.9892 10.4513 14.9232L18.8894 10.9621C19.4212 10.7135 19.6477 10.0811 19.396 9.54943C19.1506 9.02086 18.515 8.79119 17.9896 9.03974L9.99824 12.79L2.01314 9.04289C1.48143 8.79119 0.849039 9.02086 0.603634 9.55258C0.351937 10.0811 0.581611 10.7135 1.11332 10.9621Z" fill="#5A6E7C"/>
              <path d="M17.9865 13.0007L9.99824 16.751L2.01314 13.0007C1.48143 12.7522 0.849039 12.9787 0.603634 13.5104C0.351937 14.0421 0.581611 14.6745 1.11332 14.923L9.54833 18.881C9.68991 18.9502 9.84407 18.9817 9.99824 18.9817C10.1524 18.9817 10.3097 18.9471 10.4513 18.881L18.8894 14.923C19.4212 14.6745 19.6477 14.0421 19.396 13.5104C19.1474 12.9818 18.5119 12.7553 17.9865 13.0007Z" fill="#5A6E7C"/> 
            </svg>
          </span>
          <span>Project</span>
        </a>
      </nav>
    </div>
    <div class="user-profile">
      <div class="profile-img">JD</div>
      <div class="profile-info">
        <div class="profile-name">John Doe</div>
        <div class="profile-role">Executive Leadership</div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content" id="mainContent">
    <div class="top-bar">
      <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#1A2340" xmlns="http://www.w3.org/2000/svg">
          <rect x="4" y="5" width="16" height="2" rx="1"/>
          <rect x="4" y="11" width="16" height="2" rx="1"/>
          <rect x="4" y="17" width="16" height="2" rx="1"/>
        </svg>
      </button>
      <div class="toggle">
        <span class="toggle-text">Ideation Studio</span>
        <label class="toggle-switch">
          <input type="checkbox" id="ideationToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <button class="new-chat-btn">
        <svg width="18" height="18" fill="none" stroke="white" stroke-width="2">
          <line x1="9" y1="4" x2="9" y2="14"/>
          <line x1="4" y1="9" x2="14" y2="9"/>
        </svg>
        New Chat
      </button>
    </div>
    <div class="container">

      <div class="questions-grid">
        <div class="question-card"><p>Simulate a scenario where U.S. tariffs on Mexican and Canadian automotive imports remain active for six months. Analyze alternative sourcing for airbags based on the following quantitative metrics: updated landed cost (factoring tariff rate, FX adjustment), supplier risk (political instability, non-tariff barriers), and supplier viability (capacity, delivery history). Recommend a prescriptive sourcing decision with an explanatory rationale</p></div>
        <div class="question-card"><p>What patterns in EV adoption can inform prctive demand forecasting and inventory optimization?</p></div>
        <div class="question-card"><p>Which emerging autonomous vehicle technology could signinficantly disrupt our current bussiness model?</p></div>
        <div class="question-card"><p>How can AI-driven insights enhance the efficiency and accuracy of our autonomous vehicle testing process?</p></div>
        <div class="question-card"><p>What digital retail innovations could most effectively differentiate our brand in a competitive automotive market?</p></div>
        <div class="question-card"><p>Can we compare the total cost of the airbags coponent for different models with the potential revenue streams?</p></div>
      </div>
      <!-- Update the chat-section styling -->
      <div class="chat-section">
        <div class="chat-messages" id="chatMessages">
          <!-- Chat messages will be displayed here -->
        </div>
        <div class="chat-input-container">
          <textarea class="chat-input" id="chatInput" placeholder="Type your question here.."></textarea>
          <div class="input-actions">
            <div class="left-actions">
              <button class="action-btn" title="Upload file" id="uploadFileBtn">
                <svg width="20" height="20" fill="none" stroke="#0066B3" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M12 16V4M8 8l4-4 4 4M4 20h16"/>
                </svg>
              </button>
              <button class="action-btn" title="Voice input" id="voiceInputBtn">
                <svg width="20" height="20" fill="none" stroke="#0066B3" stroke-width="2" viewBox="0 0 24 24">
                  <rect x="9" y="2" width="6" height="12" rx="3"/>
                  <path d="M5 10v2a7 7 0 0 0 14 0v-2"/>
                  <line x1="12" y1="22" x2="12" y2="18"/>
                  <line x1="8" y1="22" x2="16" y2="22"/>
                </svg>
              </button>
            </div>
            <div class="right-actions">
              <div class="plus-dropdown">
                <button class="plus-btn" id="plusBtn"><span id="plusBtnLabel">Plus</span> â–¼</button>
                <div class="plus-menu" id="plusMenu" style="display:none;">
                  <div class="plus-item" data-value="Plus">
                    <svg width="20" height="20" fill="none" stroke="#0096D6" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
                    Plus
                  </div>
                  <div class="plus-item" data-value="Play">
                    <svg width="20" height="20" fill="none" stroke="#E04A1F" stroke-width="2" viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
                    Play
                  </div>
                  <div class="plus-item" data-value="Ideation">
                    <svg width="20" height="20" fill="none" stroke="#1A8FE3" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg>
                    Ideation
                  </div>
                </div>
              </div>
              <button class="send-btn" title="Send message" id="sendMessageBtn">
                <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <!-- Action Twin Modal -->
  <div id="actionTwinModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Add an Action Twin</h2>
      <p class="subtitle">Train the model to get more personalised response.</p>
      <div class="form-grid">
        <div class="form-group">
          <input type="text" placeholder="Agent Name" class="form-input">
        </div>
        <div class="form-group">
          <input type="text" placeholder="Description" class="form-input">
        </div>
        <div class="form-group">
          <div class="select-wrapper">
            <select class="form-input">
              <option value="" disabled selected>Preferred Interaction Mode</option>
              <option value="1">Mode 1</option>
              <option value="2">Mode 2</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <input type="text" placeholder="Instructions" class="form-input">
        </div>
        <div class="form-group">
          <input type="url" placeholder="Website URL" class="form-input">
        </div>
        <div class="form-group">
          <div class="upload-box">
            <div class="upload-area">
              Drag & Drop or click to upload
            </div>
          </div>
        </div>
      </div>
      <div class="button-group">
        <button class="btn btn-cancel">Cancel</button>
        <button class="btn btn-save">Save</button>
      </div>
    </div>
  </div>
  <!-- Talk with Analyst Modal -->
  <div id="talkAnalystModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Talk with Analyst</h2>
      <p class="subtitle">Let us know what we can do better.</p>
      <div class="form-content">
        <textarea placeholder="Type here.." class="text-input"></textarea>
        <div class="upload-box">
          <div class="upload-area">
            Drag & Drop or click to upload
          </div>
        </div>
      </div>
      <div class="button-group">
        <button class="btn btn-cancel">Cancel</button>
        <button class="btn btn-submit">Submit</button>
      </div>
    </div>
  </div>
  <!-- Add Project Modal -->
  <div id="addProjectModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Add a Project</h2>
      <div class="form-grid">
        <div class="form-group">
          <input type="text" placeholder="Project Name" class="form-input">
        </div>
        <div class="form-group">
          <input type="text" placeholder="Description" class="form-input">
        </div>
      </div>
      <div class="form-group">
        <label for="inviteEmails">Invite by email (comma separated)</label>
        <input type="text" id="inviteEmails" placeholder="e.g., email1@example.com, email2@exa" class="form-input">
      </div>
      <div class="button-group">
        <button class="btn btn-cancel" id="cancelAddProjectBtn">Cancel</button>
        <button class="btn btn-save" id="saveProjectBtn">Save</button>
      </div>
    </div>
  </div>
  <!-- Manage Invitees Modal -->
  <div id="manageInviteesModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Manage Invitees for <span id="manageInviteesProjectName"></span></h2>
      <div class="form-group">
        <label for="currentInvitees">Current Invitees:</label>
        <input type="text" id="currentInvitees" class="form-input" readonly>
      </div>
      <div class="form-group">
        <label for="newInvitees">Add New Invitees (comma-separated)</label>
        <textarea id="newInvitees" class="form-input" placeholder="email1@example.com, email2@example.com"></textarea>
        <small>Enter email addresses separated by commas</small>
      </div>
      <div class="button-group">
        <button class="btn btn-cancel" id="cancelManageInviteesBtn">Cancel</button>
        <button class="btn btn-save" id="saveManageInviteesBtn">Save Changes</button>
      </div>
    </div>
  </div>


  <script type="module">
    import { createChat, getAllChats, getChatsByUserId, deleteChat } from './chatApi.js';
    import { createResponse, getAllResponses, reactToResponse } from './responsesApi.js';
    import { createMessage, getMessagesByChatId } from './messageApi.js';

    // Add this at the beginning of your script
    const mainContent = document.getElementById('mainContent');
    
    // Custom notification function
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' ? 
                        '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' :
                        '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/>'
                    }
                </svg>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Trigger animation
        setTimeout(() => notification.classList.add('show'), 10);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Add styles for notifications
    const style = document.createElement('style');
    style.textContent = `
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #1A2340;
        }
        
        .notification.success {
            border-left: 4px solid #0066B3;
        }
        
        .notification.success svg {
            color: #0066B3;
        }
        
        .notification.error {
            border-left: 4px solid #E04A1F;
        }
        
        .notification.error svg {
            color: #E04A1F;
        }
    `;
    document.head.appendChild(style);

    // Update user profile from stored data
    function updateUserProfile() {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        if (userData.email) {
            // Update profile name - use email if name is not available
            const displayName = userData.name || userData.email.split('@')[0];
            document.querySelector('.profile-name').textContent = displayName;
            
            // Update profile image initials from email or name
            const initials = displayName
                .split(/[\s@]/) // Split by space or @ symbol
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
            document.querySelector('.profile-img').textContent = initials;
            
            // Update role if available, otherwise use a default
            const role = userData.role ? 
                userData.role.charAt(0).toUpperCase() + userData.role.slice(1) :
                'User';
            document.querySelector('.profile-role').textContent = role;
        }
    }

    // Call the function when page loads
    document.addEventListener('DOMContentLoaded', updateUserProfile);

    // Existing sidebar toggle functionality
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const fullLogo = document.querySelector('.full-logo');
    const closedLogo = document.querySelector('.closed-logo');
    sidebarToggle.addEventListener('click', function() {
      sidebar.classList.toggle('closed');
      mainContent.classList.toggle('sidebar-closed');
      sidebarToggle.classList.toggle('open');
      
      // Toggle logo visibility
      if (sidebar.classList.contains('closed')) {
          fullLogo.style.display = 'none';
          closedLogo.style.display = 'block';
      } else {
          fullLogo.style.display = 'block';
          closedLogo.style.display = 'none';
      }
    });
    const actionTwinModal = document.getElementById('actionTwinModal');
    const talkAnalystModal = document.getElementById('talkAnalystModal');
    const addProjectModal = document.getElementById('addProjectModal'); // Get add project modal
    const manageInviteesModal = document.getElementById('manageInviteesModal'); // Get manage invitees modal

    // Sidebar navigation
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        navItems.forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        const text = this.innerText.trim();
        
        // Reset chat header and current chat ID when switching pages
        document.getElementById('currentChatTitle').textContent = 'Ideation Studio';
        currentChatId = null;
        
        if (text === 'Action Twin') {
          loadActionTwinPage();
        } else if (text === 'Talk with Analyst') {
          talkAnalystModal.style.display = 'flex';
          actionTwinModal.style.display = 'none';
          addProjectModal.style.display = 'none';
          manageInviteesModal.style.display = 'none';

          // Add submit button handler for Talk with Analyst modal
          const submitBtn = talkAnalystModal.querySelector('.btn-submit');
          if (submitBtn) {
            submitBtn.addEventListener('click', () => {
              const message = talkAnalystModal.querySelector('.text-input').value.trim();
              
              if (!message) {
                showNotification('Please enter your message before submitting.', 'error');
                return;
              }

              // Get existing analyst messages from local storage
              const existingMessages = JSON.parse(localStorage.getItem('analystMessages')) || [];

              // Create new message object
              const newMessage = {
                id: Date.now(),
                message,
                timestamp: new Date().toISOString(),
                status: 'Pending'
              };

              // Add new message and save back to local storage
              existingMessages.push(newMessage);
              localStorage.setItem('analystMessages', JSON.stringify(existingMessages));

              // Clear form and hide modal
              talkAnalystModal.querySelector('.text-input').value = '';
              talkAnalystModal.style.display = 'none';

              showNotification('Your message has been sent to our analyst team. We will review and respond shortly.');
            });
          }
        } else if (text === 'Project') {
          actionTwinModal.style.display = 'none';
          talkAnalystModal.style.display = 'none';
          addProjectModal.style.display = 'none';
          manageInviteesModal.style.display = 'none';
          loadProject();
        } else {
          actionTwinModal.style.display = 'none';
          talkAnalystModal.style.display = 'none';
          addProjectModal.style.display = 'none';
          manageInviteesModal.style.display = 'none';
          loadMainPage();
        }
      });
    });
    // Modal close logic
    [...document.querySelectorAll('.modal')].forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.style.display = 'none';
      });
    });
    [...document.querySelectorAll('.btn-cancel')].forEach(btn => {
      btn.addEventListener('click', function() {
        btn.closest('.modal').style.display = 'none';
      });
    });

    // Loaders for main content - Moved to this script block
    function loadMainPage() {
      document.querySelector('.container').style.display = '';
      document.getElementById('savedReportsSection')?.remove();
      document.getElementById('projectSection')?.remove();
      document.getElementById('actionTwinSection')?.remove();
    }

    // Add these functions before the loadSavedReports function
    const generateTimelineData = (baseline, points) => {
      const data = [];
      let currentValue = baseline;
      
      for (let i = 0; i < points; i++) {
        const change = (Math.random() - 0.5) * 10;
        currentValue = Math.max(0, Math.min(100, currentValue + change));
        data.push({
          month: `Month ${i + 1}`,
          value: currentValue
        });
      }
      
      return data;
    };

    // Update the loadSavedReports function to include timeline charts
    function loadSavedReports() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('projectSection')?.remove();
      document.getElementById('actionTwinSection')?.remove();
      
      if (!document.getElementById('savedReportsSection')) {
        const section = document.createElement('section');
        section.id = 'savedReportsSection';
        
        const content = `
          <div class="flex-1 flex flex-col overflow-hidden bg-gradient-to-br from-gray-50 to-white">
            <header class="border-b border-gray-200 p-4 flex justify-between items-center bg-white shadow-sm">
              <div class="flex items-center text-gray-700">
                <i data-lucide="shield" class="w-5 h-5 mr-2 text-orange-500"></i>
                <span class="font-medium">Saved Reports</span>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-secondary">
                  <i data-lucide="filter" class="w-4 h-4 mr-2"></i>
                  Filter Reports
                </button>
                <button class="btn btn-primary">
                  <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                  New Report
                </button>
              </div>
            </header>

            <div class="flex-1 overflow-auto custom-scrollbar">
              <div class="reports-grid">
                <!-- Report Card 1 -->
                <div class="report-card">
                  <div class="report-card-header">
                    <h3 class="text-lg font-semibold text-gray-800">Supply Chain Risk Assessment</h3>
                    <p class="text-sm text-gray-500">Last updated: March 15, 2024</p>
                  </div>
                  <div class="report-card-body">
                    <div class="flex justify-between items-center mb-4">
                      <span class="text-sm text-gray-600">Risk Score</span>
                      <span class="text-lg font-semibold text-red-600">56</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                      <span class="text-sm text-gray-600">Quality Score</span>
                      <span class="text-lg font-semibold text-green-600">75</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-sm text-gray-600">Total Assets</span>
                      <span class="text-lg font-semibold text-gray-800">100</span>
                    </div>
                  </div>
                  <div class="report-card-footer">
                    <span class="status-badge completed">Completed</span>
                    <div class="flex gap-2">
                      <button class="btn btn-secondary">
                        <i data-lucide="download" class="w-4 h-4"></i>
                      </button>
                      <button class="btn btn-secondary">
                        <i data-lucide="share-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Report Card 2 -->
                <div class="report-card">
                  <div class="report-card-header">
                    <h3 class="text-lg font-semibold text-gray-800">Tariff Impact Analysis</h3>
                    <p class="text-sm text-gray-500">Last updated: March 14, 2024</p>
                  </div>
                  <div class="report-card-body">
                    <div class="flex justify-between items-center mb-4">
                      <span class="text-sm text-gray-600">Impact Score</span>
                      <span class="text-lg font-semibold text-orange-600">42</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                      <span class="text-sm text-gray-600">Cost Impact</span>
                      <span class="text-lg font-semibold text-red-600">$2.4M</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-sm text-gray-600">Affected Items</span>
                      <span class="text-lg font-semibold text-gray-800">24</span>
                    </div>
                  </div>
                  <div class="report-card-footer">
                    <span class="status-badge in-progress">In Progress</span>
                    <div class="flex gap-2">
                      <button class="btn btn-secondary">
                        <i data-lucide="download" class="w-4 h-4"></i>
                      </button>
                      <button class="btn btn-secondary">
                        <i data-lucide="share-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Report Card 3 -->
                <div class="report-card">
                  <div class="report-card-header">
                    <h3 class="text-lg font-semibold text-gray-800">Supplier Performance Review</h3>
                    <p class="text-sm text-gray-500">Last updated: March 13, 2024</p>
                  </div>
                  <div class="report-card-body">
                    <div class="flex justify-between items-center mb-4">
                      <span class="text-sm text-gray-600">Performance Score</span>
                      <span class="text-lg font-semibold text-green-600">82</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                      <span class="text-sm text-gray-600">On-time Delivery</span>
                      <span class="text-lg font-semibold text-green-600">94%</span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-sm text-gray-600">Quality Rating</span>
                      <span class="text-lg font-semibold text-gray-800">4.2/5</span>
                    </div>
                  </div>
                  <div class="report-card-footer">
                    <span class="status-badge pending">Pending Review</span>
                    <div class="flex gap-2">
                      <button class="btn btn-secondary">
                        <i data-lucide="download" class="w-4 h-4"></i>
                      </button>
                      <button class="btn btn-secondary">
                        <i data-lucide="share-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        section.innerHTML = content;
        document.querySelector('main').appendChild(section);

        // Initialize Lucide icons
        lucide.createIcons();

        // Add click handlers for buttons
        document.querySelectorAll('.btn').forEach(button => {
          button.addEventListener('click', function(e) {
            const action = this.querySelector('i').getAttribute('data-lucide');
            console.log(`Button clicked: ${action}`);
            // Add your button click handlers here
          });
        });

        // Initialize Lucide icons
        lucide.createIcons();

        // Add click handler for saved reports
        document.getElementById('savedReportsNav').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'report.html';
        });

        // Add click handlers for saved report buttons
        document.querySelectorAll('.saved-report-card .action-button').forEach(button => {
            button.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                const reportId = this.closest('.saved-report-card').getAttribute('data-id');
                handleSavedReportAction(action, reportId);
            });
        });

        // Function to handle saved report actions
        function handleSavedReportAction(action, reportId) {
            switch(action) {
                case 'view':
                    // Implement view functionality
                    console.log('View report:', reportId);
                    break;
                case 'edit':
                    // Implement edit functionality
                    console.log('Edit report:', reportId);
                    break;
                case 'delete':
                    // Implement delete functionality
                    console.log('Delete report:', reportId);
                    break;
            }
        }
      }
    }

    // Function to initialize charts
    function initializeCharts() {
      // Risk Score Chart
      const riskScoreData = [
        { name: 'China', value: 75 },
        { name: 'Vietnam', value: 45 },
        { name: 'Thailand', value: 60 },
        { name: 'Mexico', value: 55 }
      ];

      const riskScoreChart = new Recharts.LineChart({
        width: 500,
        height: 250,
        data: riskScoreData,
        margin: { top: 20, right: 30, left: 20, bottom: 5 }
      });

      riskScoreChart.add(new Recharts.Line({
        dataKey: 'value',
        stroke: '#0066B3',
        strokeWidth: 2,
        dot: { fill: '#0066B3' }
      }));

      riskScoreChart.add(new Recharts.XAxis({ dataKey: 'name' }));
      riskScoreChart.add(new Recharts.YAxis());
      riskScoreChart.add(new Recharts.Tooltip());

      // Landing Cost Chart
      const landingCostData = [
        { name: 'China', value: 100 },
        { name: 'Vietnam', value: 85 },
        { name: 'Thailand', value: 90 },
        { name: 'Mexico', value: 95 }
      ];

      const landingCostChart = new Recharts.BarChart({
        width: 500,
        height: 250,
        data: landingCostData,
        margin: { top: 20, right: 30, left: 20, bottom: 5 }
      });

      landingCostChart.add(new Recharts.Bar({
        dataKey: 'value',
        fill: '#0066B3'
      }));

      landingCostChart.add(new Recharts.XAxis({ dataKey: 'name' }));
      landingCostChart.add(new Recharts.YAxis());
      landingCostChart.add(new Recharts.Tooltip());

      // Render charts
      ReactDOM.render(riskScoreChart, document.getElementById('riskScoreChart'));
      ReactDOM.render(landingCostChart, document.getElementById('landingCostChart'));
    }

    // Function to load recommendation data
    function loadRecommendationData() {
      const recommendations = [
        {
          country: 'China',
          landingCost: '$1,200',
          tariffImpact: '25%',
          riskScore: '75',
          qualityScore: '85',
          strategicFit: 'High',
          recommendation: 'Reduce dependency'
        },
        {
          country: 'Vietnam',
          landingCost: '$950',
          tariffImpact: '5%',
          riskScore: '45',
          qualityScore: '80',
          strategicFit: 'High',
          recommendation: 'Increase sourcing'
        },
        {
          country: 'Thailand',
          landingCost: '$1,000',
          tariffImpact: '10%',
          riskScore: '60',
          qualityScore: '82',
          strategicFit: 'Medium',
          recommendation: 'Maintain current level'
        },
        {
          country: 'Mexico',
          landingCost: '$1,100',
          tariffImpact: '0%',
          riskScore: '55',
          qualityScore: '78',
          strategicFit: 'Medium',
          recommendation: 'Explore opportunities'
        }
      ];

      const tableBody = document.getElementById('recommendationTableBody');
      tableBody.innerHTML = recommendations.map(rec => `
        <tr class="border-b border-gray-200 hover:bg-gray-50">
          <td class="py-3 px-4 text-left">${rec.country}</td>
          <td class="py-3 px-4 text-right">${rec.landingCost}</td>
          <td class="py-3 px-4 text-right">${rec.tariffImpact}</td>
          <td class="py-3 px-4 text-right">${rec.riskScore}</td>
          <td class="py-3 px-4 text-right">${rec.qualityScore}</td>
          <td class="py-3 px-4 text-center">${rec.strategicFit}</td>
          <td class="py-3 px-4 text-center">${rec.recommendation}</td>
        </tr>
      `).join('');
    }

    // Function to load key insights
    function loadKeyInsights() {
      const keyInsights = [
        "China's high concentration risk (90% of sourcing) and tariff impact create significant exposure",
        "Vietnam emerges as the optimal alternative with lower risk scores and high strategic fit",
        "A phased transition strategy would yield significant risk reduction and cost savings"
      ];

      const insightsList = document.getElementById('keyInsightsList');
      insightsList.innerHTML = keyInsights.map(insight => `
        <li>${insight}</li>
      `).join('');

      const recommendationText = document.getElementById('recommendationText');
      recommendationText.innerHTML = `
        <strong>Recommendation:</strong> Implement a phased transition beginning with volume shift to Vietnam, followed by secondary sourcing development in Thailand and Mexico.
      `;
    }

    // Function to download report
    function downloadReport() {
      // Create a temporary link element
      const link = document.createElement('a');
      link.href = '#';
      link.download = 'supply-chain-risk-assessment.pdf';
      
      // Simulate click to trigger download
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('Report download started');
    }

    // Function to start new assessment
    function startNewAssessment() {
      showNotification('Starting new assessment...');
      // Add your new assessment logic here
    }

    function loadProject() {
      document.querySelector('.container').style.display = 'none';
      document.getElementById('savedReportsSection')?.remove();
      document.getElementById('actionTwinSection')?.remove();
      if (!document.getElementById('projectSection')) {
        const section = document.createElement('section');
        section.id = 'projectSection';
        section.innerHTML = `
          <div class="project-page-container">
            <div class="project-header-bar">
              <h2>Projects - Created by you</h2>
              <button class="create-new-project-btn">+ Create New Project</button>
            </div>
            <div class="project-table-container">
              <table class="project-table">
                <thead>
                  <tr>
                    <th>Project Name</th>
                    <th>Description</th>
                    <th>Invites</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Project rows will be rendered here by renderProjectsTable -->
                </tbody>
              </table>
            </div>
          </div>
        `;
        mainContent.appendChild(section);

        // Add event listeners for the Add Project modal within loadProject
        const addProjectModal = document.getElementById('addProjectModal');
        const createNewProjectBtn = section.querySelector('.create-new-project-btn');
        const cancelAddProjectBtn = document.getElementById('cancelAddProjectBtn');
        const saveProjectBtn = document.getElementById('saveProjectBtn'); // Get the save button
        const projectNameInput = addProjectModal.querySelector('input[placeholder="Project Name"]');
        const projectDescriptionInput = addProjectModal.querySelector('input[placeholder="Description"]');
        const inviteEmailsInput = addProjectModal.querySelector('#inviteEmails');

        // Show the modal when the "Create New Project" button is clicked
        if (createNewProjectBtn) {
          createNewProjectBtn.addEventListener('click', () => {
            if (addProjectModal) {
              addProjectModal.style.display = 'flex';
            }
          });
        }

        // Hide the modal when the "Cancel" button is clicked
        if (cancelAddProjectBtn) {
          cancelAddProjectBtn.addEventListener('click', () => {
            if (addProjectModal) {
              addProjectModal.style.display = 'none';
              // Clear form fields when canceling
              projectNameInput.value = '';
              projectDescriptionInput.value = '';
              inviteEmailsInput.value = '';
            }
          });
        }

        // Hide the modal when clicking outside the modal content
        if (addProjectModal) {
          addProjectModal.addEventListener('click', (e) => {
            if (e.target === addProjectModal) {
              addProjectModal.style.display = 'none';
              // Clear form fields when clicking outside
              projectNameInput.value = '';
              projectDescriptionInput.value = '';
              inviteEmailsInput.value = '';
            }
          });
        }

        // Handle Save button click
        if (saveProjectBtn) {
          saveProjectBtn.addEventListener('click', () => {
            const projectName = projectNameInput.value.trim();
            const projectDescription = projectDescriptionInput.value.trim();
            const inviteEmails = inviteEmailsInput.value.trim();

            if (!projectName) {
              showNotification('Project Name is required.', 'error');
              return;
            }

            const newProject = {
              id: Date.now(),
              name: projectName,
              description: projectDescription,
              invites: inviteEmails
            };

            // Get existing projects from local storage
            const existingProjects = JSON.parse(localStorage.getItem('projects')) || [];

            // Add new project and save back to local storage
            existingProjects.push(newProject);
            localStorage.setItem('projects', JSON.stringify(existingProjects));

            // Clear form and hide modal
            projectNameInput.value = '';
            projectDescriptionInput.value = '';
            inviteEmailsInput.value = '';
            addProjectModal.style.display = 'none';

            showNotification('Project created successfully!');
            renderProjectsTable();
          });
        }

        // Initial rendering of the table
        renderProjectsTable();
      }
    }

    // Function to render projects table from localStorage
    function renderProjectsTable() {
      const projectTableBody = document.querySelector('.project-table tbody');
      if (!projectTableBody) return;

      // Clear existing table rows
      projectTableBody.innerHTML = '';

      // Get projects from local storage
      const projects = JSON.parse(localStorage.getItem('projects')) || [];

      // Generate HTML for each project and append to the table body
      projects.forEach(project => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${project.name}</td>
          <td>${project.description}</td>
          <td>${project.invites}</td>
          <td><button class="manage-invitees-btn" data-project-id="${project.id}">Manage Invitees</button></td>
        `;
        projectTableBody.appendChild(row);
      });

      // Add event listeners to the Manage Invitees buttons
      const manageInviteesButtons = projectTableBody.querySelectorAll('.manage-invitees-btn');
      const manageInviteesModal = document.getElementById('manageInviteesModal');
      const manageInviteesProjectName = document.getElementById('manageInviteesProjectName');
      const currentInviteesInput = document.getElementById('currentInvitees');
      const newInviteesTextarea = document.getElementById('newInvitees');
      const cancelManageInviteesBtn = document.getElementById('cancelManageInviteesBtn');
      const saveManageInviteesBtn = document.getElementById('saveManageInviteesBtn');

      manageInviteesButtons.forEach(button => {
        button.addEventListener('click', (event) => {
          const projectId = event.target.dataset.projectId;
          const project = projects.find(p => p.id == projectId);

          if (project && manageInviteesModal) {
            // Populate the modal with project data
            manageInviteesProjectName.textContent = project.name;
            currentInviteesInput.value = project.invites;
            newInviteesTextarea.value = ''; // Clear the new invitees textarea
            manageInviteesModal.style.display = 'flex';

            // Store the project ID on the save button temporarily
            saveManageInviteesBtn.dataset.projectId = projectId;
          }
        });
      });

      // Close modal when clicking the close button (X)
      const closeButton = manageInviteesModal.querySelector('.close');
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          manageInviteesModal.style.display = 'none';
        });
      }

      // Close modal when clicking outside the modal content
      if (manageInviteesModal) {
        manageInviteesModal.addEventListener('click', (e) => {
          if (e.target === manageInviteesModal) {
            manageInviteesModal.style.display = 'none';
          }
        });
      }

      // Handle Save Changes button click in Manage Invitees modal
      if (saveManageInviteesBtn) {
        saveManageInviteesBtn.addEventListener('click', (event) => {
          const projectId = event.target.dataset.projectId;
          const newInvitees = newInviteesTextarea.value.trim();

          // Get existing projects
          const projects = JSON.parse(localStorage.getItem('projects')) || [];

          // Find the project to update
          const projectIndex = projects.findIndex(p => p.id == projectId);

          if (projectIndex !== -1) {
            // Update the invites (add new ones to existing, avoid duplicates)
            const existingInvites = projects[projectIndex].invites.split(',').map(email => email.trim()).filter(email => email !== '');
            const newInvitesArray = newInvitees.split(',').map(email => email.trim()).filter(email => email !== '');
            
            const updatedInvites = [...new Set([...existingInvites, ...newInvitesArray])].join(', ');

            projects[projectIndex].invites = updatedInvites;

            // Save updated projects back to local storage
            localStorage.setItem('projects', JSON.stringify(projects));

            // Refresh the table display
            renderProjectsTable();

            // Hide the modal
            manageInviteesModal.style.display = 'none';

            // Show success message
            const projectName = projects[projectIndex].name;
            showNotification(`Invites have been updated for project "${projectName}". Team members will be notified.`);
          }
        });
      }

      // Handle Cancel button click in Manage Invitees modal
      if (cancelManageInviteesBtn) {
        cancelManageInviteesBtn.addEventListener('click', () => {
          manageInviteesModal.style.display = 'none';
        });
      }
    }

    // Chat functionality
    const chatInput = document.getElementById('chatInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const chatMessages = document.getElementById('chatMessages');
    const newChatBtn = document.querySelector('.new-chat-btn');

    let currentChatId = null;

    // Add New Chat button handler
    if (newChatBtn) {
        newChatBtn.addEventListener('click', () => {
            // Reset chat state
            currentChatId = null;
            chatMessages.innerHTML = '';
            chatInput.value = '';
            
            // Reset chat header
            document.getElementById('currentChatTitle').textContent = 'Ideation Studio';
            
            // Show questions grid and chat section
            document.querySelector('.questions-grid').style.display = 'grid';
            document.querySelector('.chat-section').style.display = 'flex';
            
            // Hide any other sections
            document.getElementById('savedReportsSection')?.remove();
            document.getElementById('projectSection')?.remove();
            document.getElementById('actionTwinSection')?.remove();
            
            // Show main container
            document.querySelector('.container').style.display = '';

            // Focus on chat input
            chatInput.focus();
        });
    }

    // Get user data from session storage
    function getUserData() {
      const userData = sessionStorage.getItem('user');
      return userData ? JSON.parse(userData) : null;
    }

    // Add this function at the top level of your script
    function cleanBotResponse(text) {
        if (!text) return '';
        let cleaned = text
            // Remove code blocks and HTML tags
            .replace(/<[^>]*>/g, '')
            .replace(/```[\s\S]*?```/g, '')
            // Remove lines with formatting instructions, code, or style references
            .replace(/^(.*format.*|.*Tailwind.*|.*class.*|.*guideline.*|.*hover.*|.*DOCTYPE.*|.*html.*|.*head.*|.*body.*|.*instruction.*|.*div.*|.*span.*|.*nested.*|.*content.*|.*properly.*|.*appropriate.*|.*spacing.*)$/gmi, '')
            // Remove lines that look like code or style
            .replace(/^\s*[-*] ?[A-Za-z0-9_\-]+:.*$/gmi, '')
            .replace(/^\s*\/\/.*/gmi, '')
            .replace(/^\s*\{.*\}\s*$/gmi, '')
            // Remove empty list items and numbers
            .replace(/^\d+\.\s*$/gm, '')
            .replace(/^\d+\.\s*/gm, '')
            // Remove bullet points
            .replace(/â€¢/g, '')
            .replace(/\s*â€¢\s*/g, '')
            // Remove any remaining formatting instructions
            .replace(/format the text as follows:.*$/gmi, '')
            .replace(/formatting instructions.*$/gmi, '')
            // Clean up whitespace and formatting
            .replace(/\n{3,}/g, '\n\n')
            .replace(/^[ \t]+|[ \t]+$/gm, '')
            .replace(/\s+/g, ' ')
            .replace(/^\s*\n/gm, '')
            .replace(/\n\s*$/g, '')
            .replace(/\s*:\s*/g, ': ')
            .replace(/\s*\.\s*/g, '. ')
            .replace(/\s*â€¢\s*/g, '')
            .trim();
        // Remove lines that are not natural sentences (e.g., lines with only symbols or code)
        cleaned = cleaned.split('\n').filter(line => /[a-zA-Z]/.test(line) && !/\{.*\}|\[.*\]|<.*>|\/\//.test(line)).join(' ').replace(/\s+/g, ' ').trim();
        // If the result is empty after cleaning, return a default message
        if (!cleaned) {
            return "I'm here to help! What would you like to know?";
        }
        return cleaned;
    }

    // Update the createMessageElement function
    function createMessageElement(messageData, isUser = true) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'response-message'}`;
        if (!isUser && messageData.response_id) {
            messageDiv.dataset.responseId = messageData.response_id;
        }
    
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if (!isUser && messageData.text) {
            // For bot responses
            const text = messageData.text.trim();
            
            // Create a wrapper for bot messages with enhanced styling
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'bot-message-wrapper';
            
            // Clean the text content
            const cleanText = cleanBotResponse(text);
            
            // Split text into sections based on headers
            const sections = cleanText.split(/(?=^[A-Z][a-z\s]+:)/m).filter(s => s.trim());
            
            sections.forEach(section => {
                // Check if section starts with a header
                const headerMatch = section.match(/^([A-Z][a-z\s]+):/);
                if (headerMatch) {
                    const header = document.createElement('h3');
                    header.className = 'bot-message-header';
                    header.textContent = headerMatch[1].trim();
                    messageWrapper.appendChild(header);
                    
                    // Get the content after the header
                    const content = section.slice(headerMatch[0].length).trim();
                    
                    // Check if content contains numbered list
                    if (content.match(/^\d+\./m)) {
                        // Create an ordered list
                        const list = document.createElement('ol');
                        list.className = 'bot-message-list';
                        
                        // Split content into list items and clean them
                        const items = content.split(/(?=^\d+\.)/m)
                            .filter(item => item.trim())
                            .map(item => {
                                // Remove the number and dot from the beginning
                                const cleanItem = item.replace(/^\d+\.\s*/, '').trim();
                                // Split into title and description if it contains a period
                                const [title, ...descParts] = cleanItem.split('.');
                                const description = descParts.join('.').trim();
                                return {
                                    title: title.trim(),
                                    description: description
                                };
                            });
                        
                        items.forEach(item => {
                            const listItem = document.createElement('li');
                            listItem.className = 'bot-message-list-item';
                            
                            // Create title element
                            const title = document.createElement('div');
                            title.className = 'list-item-title';
                            title.textContent = item.title;
                            listItem.appendChild(title);
                            
                            // Create description element if it exists
                            if (item.description) {
                                const description = document.createElement('div');
                                description.className = 'list-item-description';
                                description.textContent = item.description;
                                listItem.appendChild(description);
                            }
                            
                            list.appendChild(listItem);
                        });
                        
                        messageWrapper.appendChild(list);
                    } else {
                        // Handle regular paragraphs
                        const paragraphs = content.split('\n\n').filter(p => p.trim());
                        paragraphs.forEach((paragraph, index) => {
                            const p = document.createElement('p');
                            p.textContent = paragraph;
                            p.className = 'bot-message-paragraph';
                            messageWrapper.appendChild(p);
                            
                            if (index < paragraphs.length - 1) {
                                messageWrapper.appendChild(document.createElement('br'));
                            }
                        });
                    }
                } else {
                    // Handle content without a header
                    const paragraphs = section.split('\n\n').filter(p => p.trim());
                    paragraphs.forEach((paragraph, index) => {
                        const p = document.createElement('p');
                        p.textContent = paragraph;
                        p.className = 'bot-message-paragraph';
                        messageWrapper.appendChild(p);
                        
                        if (index < paragraphs.length - 1) {
                            messageWrapper.appendChild(document.createElement('br'));
                        }
                    });
                }
            });
            
            // Add reaction buttons for bot messages
            const reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'message-reactions';
            
            const reactions = [
                { emoji: 'ðŸ‘', value: 'like' },
                { emoji: 'ðŸ‘Ž', value: 'dislike' },
                { emoji: 'ðŸ’¡', value: 'helpful' }
            ];
            
            reactions.forEach(reaction => {
                const button = document.createElement('button');
                button.className = 'reaction-btn';
                button.dataset.reaction = reaction.value;
                button.textContent = reaction.emoji;
                button.title = `Mark as ${reaction.value}`;
                reactionsDiv.appendChild(button);
            });
            
            contentDiv.appendChild(messageWrapper);
            contentDiv.appendChild(reactionsDiv);
        } else {
            // For user messages
            const userMessageWrapper = document.createElement('div');
            userMessageWrapper.className = 'user-message-wrapper';
            userMessageWrapper.textContent = messageData.text;
            contentDiv.appendChild(userMessageWrapper);
        }
    
        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    
        messageDiv.appendChild(contentDiv);
        messageDiv.appendChild(timeDiv);
    
        return messageDiv;
    }

    // Display message in chat
    function displayMessage(message, isUser = true) {
        const messageElement = createMessageElement(message, isUser);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Show chat section and hide questions grid when messages are present
        if (chatMessages.children.length > 0) {
            document.querySelector('.questions-grid').style.display = 'none';
            document.querySelector('.chat-section').style.display = 'flex';
        }

        return messageElement;
    }

    // Function to update chat title based on user message
    async function updateChatTitle(messageText) {
        if (!currentChatId) return;
        
        try {
            // Get the current chat
            const chat = await getChatById(currentChatId);
            if (!chat) return;

            // Update the chat title with the new message
            const updatedChatData = {
                ...chat,
                title: messageText.substring(0, 50), // Limit title length
                updatedAt: new Date().toISOString()
            };

            // Update chat in database
            await updateChat(currentChatId, updatedChatData);

            // Update UI
            document.getElementById('currentChatTitle').textContent = updatedChatData.title;
        } catch (error) {
            console.error('Error updating chat title:', error);
        }
    }

    // Handle sending messages
    async function handleSendMessage() {
        const messageText = chatInput.value.trim();
        if (!messageText) return;
    
        try {
            // Disable input and show sending state
            chatInput.disabled = true;
            chatInput.classList.add('sending');
    
            const userData = getUserData();
            if (!userData) {
                console.error('User not logged in');
                return;
            }
    
            // Display user message immediately
            const userMessageData = { text: messageText, sender: 'user', createdAt: new Date().toISOString() };
            displayMessage(userMessageData, true);
    
            // Clear input after displaying message
            chatInput.value = '';
            chatInput.style.height = 'auto';
    
            // If no current chat, create a new one
            if (!currentChatId) {
                const chatData = {
                    user_id: userData.id,
                    title: messageText.substring(0, 50),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const newChat = await createChat(chatData);
                currentChatId = newChat.id;
                
                // Update chat header with new title
                document.getElementById('currentChatTitle').textContent = chatData.title;
            } else {
                // Update chat title for existing chat
                await updateChatTitle(messageText);
            }
    
            // Create user message within the current chat
            const messageData = {
                chat_id: currentChatId,
                sender: 'user',
                text: messageText,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
    
            const sentMessage = await createMessage(messageData);
    
            // Display processing placeholder
            const processingMessageData = { 
                text: 'MetaBrain is thinking...', 
                sender: 'bot', 
                createdAt: new Date().toISOString() 
            };
            const processingMessageElement = displayMessage(processingMessageData, false);
            
            // Add bot logo and animation to processing message
            const processingContent = processingMessageElement.querySelector('.message-content');
            processingContent.innerHTML = `
                <div class="processing-message">
                    <div class="bot-logo">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066B3" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v4l3 3"/>
                        </svg>
                    </div>
                    <div class="processing-text">MetaBrain is thinking...</div>
                    <div class="processing-dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            `;
    
            try {
                const response = await fetch('https://tvs-motors-api.eficensittest.com/tvs/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'accept': 'application/json'
                    },
                    body: JSON.stringify({
                        query: messageText,
                        type: 'query'
                    })
                });
    
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
    
                const botResponse = await response.json();
                
                // Clean the bot response using the new function
                const cleanedResponse = cleanBotResponse(botResponse.response);

                // Create a response record with cleaned text
                const responseData = {
                    chat_id: currentChatId,
                    message_id: sentMessage.id,
                    text: cleanedResponse,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const createdResponse = await createResponse(responseData);

                // Create a message record for the bot response
                const botMessageData = {
                    chat_id: currentChatId,
                    sender: 'bot',
                    text: cleanedResponse,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                await createMessage(botMessageData);

                // Remove processing message
                if (processingMessageElement && processingMessageElement.parentNode) {
                    processingMessageElement.parentNode.removeChild(processingMessageElement);
                }

                // Display the cleaned bot response
                const displayData = {
                    text: cleanedResponse,
                    sender: 'bot',
                    createdAt: new Date().toISOString(),
                    response_id: createdResponse.id
                };

                displayMessage(displayData, false);

            } catch (error) {
                console.error('Error getting bot response:', error);
                if (processingMessageElement) {
                    processingMessageElement.textContent = 'Sorry, there was an error processing your request.';
                }
            }
    
        } catch (error) {
            console.error('Error in handleSendMessage:', error);
        } finally {
            // Re-enable input and remove sending state
            chatInput.disabled = false;
            chatInput.classList.remove('sending');
            chatInput.focus();
        }
    }

    // Handle reactions
    function handleReaction(responseId, reaction) {
      if (!responseId) {
          console.error('Cannot react: No response ID provided.');
          // Optionally display an error to the user
          return;
      }
      reactToResponse(responseId, reaction)
        .then(() => {
          console.log('Reaction recorded successfully for response ID:', responseId, 'reaction:', reaction);
          // Optionally provide visual feedback to the user that the reaction was recorded
        })
        .catch(error => {
          console.error('Error recording reaction for response ID:', responseId, ':', error);
          // Optionally display an error to the user
        });
    }

    // Event listeners for chat functionality
    sendMessageBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
      }
    });

    // Event delegation for reaction buttons
    chatMessages.addEventListener('click', (e) => {
      if (e.target.classList.contains('reaction-btn')) {
        const messageElement = e.target.closest('.message');
        const responseId = messageElement ? messageElement.dataset.responseId : null;
        const reaction = e.target.dataset.reaction;
        if (responseId && reaction) {
            handleReaction(responseId, reaction);
        } else {
            console.warn('Could not get response ID or reaction from clicked element.', e.target);
        }
      }
    });

    // Load user's chats and messages when page loads
    // Update loadUserChats function
    async function loadUserChats() {
      try {
        const userData = getUserData();
        if (!userData) return;

        const chats = await getChatsByUserId(userData.id);
        
        // Update sidebar with chat history
        const chatHistory = document.createElement('div');
        chatHistory.className = 'chat-history';
        
        // Group chats by date
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const lastWeek = new Date(today);
        lastWeek.setDate(lastWeek.getDate() - 7);
        
        const groups = {
          today: [],
          yesterday: [],
          lastWeek: [],
          older: []
        };
        
        // Sort chats by date
        for (const chat of chats) {
          const chatDate = new Date(chat.createdAt);
          if (chatDate >= today) {
            groups.today.push(chat);
          } else if (chatDate >= yesterday) {
            groups.yesterday.push(chat);
          } else if (chatDate >= lastWeek) {
            groups.lastWeek.push(chat);
          } else {
            groups.older.push(chat);
          }
        }
        
        // Create sections for each time period
        const timeGroups = [
          { key: 'today', label: 'Today' },
          { key: 'yesterday', label: 'Yesterday' },
          { key: 'lastWeek', label: 'Last Week' },
          { key: 'older', label: 'Older' }
        ];
        
        for (const group of timeGroups) {
          if (groups[group.key].length > 0) {
            const section = document.createElement('div');
            section.className = 'chat-history-section';
            
            const header = document.createElement('div');
            header.className = 'chat-history-header';
            header.textContent = group.label;
            section.appendChild(header);
            
            const list = document.createElement('div');
            list.className = 'chat-history-list';
            
            // Sort chats within each group by time (newest first)
            const sortedChats = groups[group.key].sort((a, b) => 
              new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            for (const chat of sortedChats) {
              const chatItem = document.createElement('div');
              chatItem.className = 'chat-history-item';
              chatItem.dataset.chatId = chat.id;
              
              const chatContent = document.createElement('div');
              chatContent.className = 'chat-history-content';
              
              const chatTitle = document.createElement('span');
              chatTitle.className = 'chat-history-title';
              chatTitle.textContent = chat.title || 'New Chat';
              
              const chatTime = document.createElement('span');
              chatTime.className = 'chat-history-time';
              const chatDate = new Date(chat.createdAt);
              chatTime.textContent = chatDate.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
              });
              
              chatContent.appendChild(chatTitle);
              chatContent.appendChild(chatTime);
              
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'chat-delete-btn';
              deleteBtn.innerHTML = `
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              `;
              
              chatItem.appendChild(chatContent);
              chatItem.appendChild(deleteBtn);
              list.appendChild(chatItem);
              
              // Add click handler for chat selection
              chatContent.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                // Prevent multiple clicks while loading
                if (chatContent.classList.contains('loading')) {
                    return;
                }
                chatContent.classList.add('loading');
                
                try {
                    // Show loading state immediately
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'loading-indicator';
                    loadingIndicator.innerHTML = `
                      <div class="loading-spinner">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#0066B3" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <path d="M12 8v4l3 3"/>
                        </svg>
                      </div>
                      <div class="loading-text">Loading chat...</div>
                    `;
                    chatMessages.innerHTML = '';
                    chatMessages.appendChild(loadingIndicator);

                    // Update UI state immediately
                    currentChatId = chat.id;
                    document.getElementById('currentChatTitle').textContent = chat.title || 'New Chat';
                    
                    // Hide all other sections and show chat section
                    document.querySelector('.container').style.display = '';
                    document.getElementById('savedReportsSection')?.remove();
                    document.getElementById('projectSection')?.remove();
                    document.getElementById('actionTwinSection')?.remove();
                    
                    // Show chat section
                    document.querySelector('.questions-grid').style.display = 'none';
                    document.querySelector('.chat-section').style.display = 'flex';

                    // Load messages
                    const messages = await getMessagesByChatId(chat.id);
                    
                    // Remove loading indicator
                    loadingIndicator.remove();
                    
                    if (messages && messages.length > 0) {
                        // Create a document fragment for better performance
                        const fragment = document.createDocumentFragment();
                        
                        // Sort messages once
                        const sortedMessages = messages.sort((a, b) => 
                            new Date(a.createdAt) - new Date(b.createdAt)
                        );
                        
                        // Process all messages at once for better performance
                        sortedMessages.forEach(msg => {
                            const messageElement = createMessageElement(msg, msg.sender === 'user');
                            fragment.appendChild(messageElement);
                        });
                        
                        // Append all messages at once
                        chatMessages.appendChild(fragment);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else {
                        chatMessages.innerHTML = '';
                        currentChatId = null;
                    }
                } catch (error) {
                    console.error('Error loading chat messages:', error);
                    chatMessages.innerHTML = '<div class="error-message">Failed to load chat messages. Please try again.</div>';
                    currentChatId = null;
                } finally {
                    // Remove loading state
                    chatContent.classList.remove('loading');
                }
              });
              
              // Add delete functionality with proper event handling
              deleteBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                showConfirmationDialog('Are you sure you want to delete this chat? This action cannot be undone.', async () => {
                    try {
                        await deleteChat(chat.id);
                        chatItem.remove();
                        if (currentChatId === chat.id) {
                            currentChatId = null;
                            chatMessages.innerHTML = '';
                            document.getElementById('currentChatTitle').textContent = 'Ideation Studio';
                            
                            // Reset UI to default home page state
                            document.querySelector('.container').style.display = '';
                            document.querySelector('.questions-grid').style.display = 'grid';
                            document.querySelector('.chat-section').style.display = 'flex';
                            chatInput.value = '';
                            chatInput.focus();
                            
                            // Hide any other sections
                            document.getElementById('savedReportsSection')?.remove();
                            document.getElementById('projectSection')?.remove();
                            document.getElementById('actionTwinSection')?.remove();
                        }
                        showNotification('Chat has been deleted successfully.');
                    } catch (error) {
                        console.error('Error deleting chat:', error);
                        showNotification('Failed to delete chat. Please try again.', 'error');
                    }
                });
              });
            }
            
            section.appendChild(list);
            chatHistory.appendChild(section);
          }
        }
        
        // Add to sidebar after nav-menu
        const navMenu = document.querySelector('.nav-menu');
        navMenu.parentNode.insertBefore(chatHistory, navMenu.nextSibling);
        
        // Show default view
        document.querySelector('.questions-grid').style.display = 'grid';
        document.querySelector('.chat-section').style.display = 'flex';
        chatMessages.innerHTML = '';
        currentChatId = null;
        document.getElementById('currentChatTitle').textContent = 'Ideation Studio';
        
      } catch (error) {
        console.error('Error loading chats:', error);
      }
    }

    // Load chats when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadUserChats();

      // Add ideation toggle functionality
      const ideationToggle = document.getElementById('ideationToggle');
      if (ideationToggle) {
        ideationToggle.addEventListener('change', () => {
          const questionsGrid = document.querySelector('.questions-grid');
          const chatSection = document.querySelector('.chat-section');
          
          if (ideationToggle.checked) {
            questionsGrid.style.display = 'none';
            chatSection.style.display = 'flex';
          } else {
            questionsGrid.style.display = 'grid';
            chatSection.style.display = 'flex';
          }
        });
      }

      // Add chat toggle switch functionality
      const chatToggle = document.getElementById('chatToggle');
      if (chatToggle) {
        chatToggle.addEventListener('change', () => {
          const chatSection = document.querySelector('.chat-section');
          if (chatToggle.checked) {
            chatSection.style.display = 'flex';
            document.querySelector('.questions-grid').style.display = 'none';
          } else {
            chatSection.style.display = 'none';
            document.querySelector('.questions-grid').style.display = 'grid';
          }
        });
      }
    });

    // Sidebar toggle functionality with animated icon
    import { handleFileUpload } from './upload.js';

    document.addEventListener('DOMContentLoaded', () => {
      // Add click handler for logo
      const logoHomeBtn = document.getElementById('logoHomeBtn');
      if (logoHomeBtn) {
        logoHomeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          // Reset chat state
          currentChatId = null;
          chatMessages.innerHTML = '';
          chatInput.value = '';
          
          // Reset chat header
          document.getElementById('currentChatTitle').textContent = 'Ideation Studio';
          
          // Show chat section and hide questions grid
          document.querySelector('.questions-grid').style.display = 'none';
          document.querySelector('.chat-section').style.display = 'flex';
          
          // Hide any other sections
          document.getElementById('savedReportsSection')?.remove();
          document.getElementById('projectSection')?.remove();
          document.getElementById('actionTwinSection')?.remove();
          
          // Show main container
          document.querySelector('.container').style.display = '';

          // Focus on chat input
          chatInput.focus();
        });
      }

      // Add click handlers to question cards
      const questionCards = document.querySelectorAll('.question-card');
      questionCards.forEach(card => {
        card.addEventListener('click', () => {
          const questionText = card.querySelector('p').textContent;
          
          // Clear any existing chat
          currentChatId = null;
          chatMessages.innerHTML = '';
          
          // Set the chat title to the question
          document.getElementById('currentChatTitle').textContent = questionText;
          
          // Hide questions grid and show chat section
          document.querySelector('.questions-grid').style.display = 'none';
          document.querySelector('.chat-section').style.display = 'flex';
          
          // Set the input value and trigger send
          chatInput.value = questionText;
          handleSendMessage();
        });
      });
    });

    function loadActionTwinPage() {
        console.log('loadActionTwinPage called');
        document.querySelector('.container').style.display = 'none';
        document.getElementById('savedReportsSection')?.remove();
        document.getElementById('projectSection')?.remove();
        
        if (!document.getElementById('actionTwinSection')) {
            const section = document.createElement('section');
            section.id = 'actionTwinSection';
            section.innerHTML = `
                <div class="action-twin-header">
                    <h2>Action Twins - Created by you</h2>
                    <button class="add-twin-btn" id="addTwinBtn">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Action Twin
                    </button>
                </div>
                <div class="action-twin-list">
                    <div class="action-twin-list-header">
                        <div class="list-header-item">Agent Name</div>
                        <div class="list-header-item">Description</div>
                        <div class="list-header-item">Interaction Mode</div>
                        <div class="list-item-cell">Instructions</div>
                        <div class="list-header-item">Website</div>
                        <div class="list-header-item">Files</div>
                    </div>
                    <!-- Action twin list items will be added here by renderActionTwins -->
                </div>
            `;
            mainContent.appendChild(section);
            console.log('actionTwinSection created and appended', section);

            // Add click handler for the Add Action Twin button
            const addTwinBtn = document.getElementById('addTwinBtn');
            addTwinBtn.addEventListener('click', () => {
                actionTwinModal.style.display = 'flex';
            });

            // Add save button handler for Action Twin modal
            const saveTwinBtn = actionTwinModal.querySelector('.btn-save');
            if (saveTwinBtn) {
                saveTwinBtn.addEventListener('click', () => {
                    const agentName = actionTwinModal.querySelector('input[placeholder="Agent Name"]').value.trim();
                    const description = actionTwinModal.querySelector('input[placeholder="Description"]').value.trim();
                    const interactionMode = actionTwinModal.querySelector('select').value;
                    const instructions = actionTwinModal.querySelector('input[placeholder="Instructions"]').value.trim();
                    const website = actionTwinModal.querySelector('input[placeholder="Website URL"]').value.trim();

                    if (!agentName) {
                        showNotification('Agent Name is required.', 'error');
                        return;
                    }

                    const newTwin = {
                        id: Date.now(),
                        agentName,
                        description,
                        interactionMode,
                        instructions,
                        website,
                        files: 'No files uploaded'
                    };

                    const existingTwins = JSON.parse(localStorage.getItem('actionTwins')) || [];
                    existingTwins.push(newTwin);
                    localStorage.setItem('actionTwins', JSON.stringify(existingTwins));

                    actionTwinModal.querySelectorAll('input').forEach(input => input.value = '');
                    actionTwinModal.querySelector('select').value = '';
                    actionTwinModal.style.display = 'none';

                    showNotification('Action Twin created successfully!');
                    renderActionTwins();
                });
            }
        }
        
        // Render existing action twins when the page is loaded
        renderActionTwins();
    }

    // Function to render action twins from localStorage
    function renderActionTwins() {
        const actionTwinList = document.querySelector('.action-twin-list');
        if (!actionTwinList) return;

        // Clear existing list items (keep header)
        const existingItems = actionTwinList.querySelectorAll('.action-twin-list-item');
        existingItems.forEach(item => item.remove());

        const storedTwins = JSON.parse(localStorage.getItem('actionTwins')) || [];

        storedTwins.forEach(twin => {
            const listItem = document.createElement('div');
            listItem.className = 'action-twin-list-item';
            listItem.dataset.id = twin.id;

            listItem.innerHTML = `
                <div class="list-item-cell">${twin.agentName}</div>
                <div class="list-item-cell">${twin.description}</div>
                <div class="list-item-cell"><span class="mode-tag">${twin.interactionMode}</span></div>
                <div class="list-item-cell">${twin.instructions}</div>
                <div class="list-item-cell">${twin.website ? `<a href="${twin.website}" target="_blank" class="website-link"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>` : ''}</div>
                <div class="list-item-cell">${twin.files}</div>
                <div class="list-item-actions">
                    <button class="twin-action-btn edit" title="Edit">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="twin-action-btn delete" title="Delete">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            `;

            actionTwinList.appendChild(listItem);
        });
    }

    // Add custom confirmation dialog function
    function showConfirmationDialog(message, onConfirm) {
        const dialog = document.createElement('div');
        dialog.className = 'confirmation-dialog';
        dialog.innerHTML = `
            <div class="confirmation-content">
                <div class="confirmation-message">${message}</div>
                <div class="confirmation-buttons">
                    <button class="btn-cancel">Cancel</button>
                    <button class="btn-confirm">Delete</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        
        // Add styles for confirmation dialog
        const style = document.createElement('style');
        style.textContent = `
            .confirmation-dialog {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            
            .confirmation-content {
                background: white;
                padding: 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                max-width: 400px;
                width: 90%;
            }
            
            .confirmation-message {
                color: #1A2340;
                margin-bottom: 20px;
                font-size: 16px;
            }
            
            .confirmation-buttons {
                display: flex;
                justify-content: flex-end;
                gap: 12px;
            }
            
            .confirmation-buttons button {
                padding: 8px 16px;
                border-radius: 4px;
                border: none;
                cursor: pointer;
                font-size: 14px;
                transition: background-color 0.2s;
            }
            
            .confirmation-buttons .btn-cancel {
                background: #F5F6F8;
                color: #1A2340;
            }
            
            .confirmation-buttons .btn-cancel:hover {
                background: #E8E9EC;
            }
            
            .confirmation-buttons .btn-confirm {
                background: #E04A1F;
                color: white;
            }
            
            .confirmation-buttons .btn-confirm:hover {
                background: #D03D12;
            }
        `;
        document.head.appendChild(style);
        
        // Add event listeners
        const cancelBtn = dialog.querySelector('.btn-cancel');
        const confirmBtn = dialog.querySelector('.btn-confirm');
        
        cancelBtn.addEventListener('click', () => {
            dialog.remove();
        });
        
        confirmBtn.addEventListener('click', () => {
            onConfirm();
            dialog.remove();
        });
        
        // Close on outside click
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                dialog.remove();
            }
        });
    }

    // Add click handler for Saved Reports navigation
    document.getElementById('savedReportsNav').addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'report.html';
    });

    // Update navigation event handlers
    document.addEventListener('DOMContentLoaded', function() {
        // Action Twin navigation
        const actionTwinNav = document.getElementById('actionTwinNav');
        if (actionTwinNav) {
            actionTwinNav.addEventListener('click', function(e) {
                e.preventDefault();
                loadActionTwinPage();
                updateActiveNav(this);
            });
        }

        // Talk with Analyst navigation
        const talkAnalystNav = document.getElementById('talkAnalystNav');
        if (talkAnalystNav) {
            talkAnalystNav.addEventListener('click', function(e) {
                e.preventDefault();
                talkAnalystModal.style.display = 'flex';
                updateActiveNav(this);
            });
        }

        // Project navigation
        const projectNav = document.getElementById('projectNav');
        if (projectNav) {
            projectNav.addEventListener('click', function(e) {
                e.preventDefault();
                loadProject();
                updateActiveNav(this);
            });
        }

        // Saved Reports navigation
        const savedReportsNav = document.getElementById('savedReportsNav');
        if (savedReportsNav) {
            savedReportsNav.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'report.html';
            });
        }

        // Helper function to update active navigation state
        function updateActiveNav(activeItem) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            activeItem.classList.add('active');
        }
    });
  </script>
</body>
</html>
